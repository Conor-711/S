Project Spec: Notion Visual ETL (V1.1 MVP)
1. 系统概述 (System Overview)
本系统是一个 macOS 本地应用，旨在将用户的截屏（像素）转化为结构化的 Notion 数据。
核心逻辑：Capture (截屏) -> Atomize (VLM 分析) -> Fit (适配与映射) -> Notion (存储)。
V1.1 版本仅支持 Notion 的两个特定场景：知识内容 (Content) 和 待办事项 (To-do)。
2. 数据库与存储 (Storage & State)
2.1 本地存储 (Local Persistence)
使用 UserDefaults 或简单的 JSON 文件存储 Notion 的架构 ID。每次启动应用时检查这些 ID 是否存在，如果不存在则重新初始化。
code
Swift
struct AppState: Codable {
    var rootPageId: String?       // Page S 的 ID
    var contentDbId: String?      // Content Database 的 ID
    var todoDbId: String?         // To-do List Database 的 ID
}
2.2 Notion 架构定义 (Target Schema)
应用在初始化时，需调用 Notion API 创建以下结构的 Database：
A. Content Database (Visual Knowledge)
| Property Name | Type | Note |
| :--- | :--- | :--- |
| Name | title | 标题/摘要 |
| Description | rich_text | 详细描述/正文 |
| Category | select | Options: AI, Design, Product |
| URL | url | 来源链接 (Metadata) |
| Screenshot | files | (V1.1 留空，不上传图片) |
| Captured At | date | ISO 8601 时间 |
B. To-do Database (Visual Tasks)
| Property Name | Type | Note |
| :--- | :--- | :--- |
| Task | title | 事项名称 |
| Due Date | date | 截止时间 |
| Assignee | rich_text | 注意：为了简化 V1.1，使用文本字段存储人名，而非 User 对象 |
| Status | status | Default: Not Started |
3. 核心数据结构 (The Atom)
VLM 分析后的输出必须严格符合此 JSON Schema。
code
Swift
// Swift Codable Definition

enum AtomType: String, Codable {
    case content
    case todo
    case discard // 如果不属于上述任何类别
}

struct Atom: Codable {
    let type: AtomType
    let payload: AtomPayload
}

struct AtomPayload: Codable {
    // 通用语义字段 (AI 生成)
    let title: String
    let description: String? // 对应 Notion 的 Description
    
    // Content 特有字段
    let category: String? // "AI", "Design", "Product"
    let sourceUrl: String?
    
    // To-do 特有字段
    let assigneeName: String? // 直接提取人名文本
    let dueDate: String? // ISO 8601 格式 (YYYY-MM-DD)
    
    // Metadata (客户端注入)
    let capturedAt: String // ISO 8601
}
4. AI 策略 (VLM Prompts)
模型选择：Gemini Flash / GPT-4o-mini (云端调用)。
系统时间注入：Prompt 中必须包含 Current Date 以便 AI 计算相对时间（如“下周五”）。
System Prompt 模板：
code
Text
You are a Visual ETL engine. Your job is to extract structured data from a screenshot for a Notion database.
Current System Time: {{CURRENT_DATE_ISO}}

Rules:
1. Analyze the image content and Determine the TYPE:
   - "todo": If it looks like a work task, a request, or has a deadline.
   - "content": If it is informational content related to "AI", "Design", or "Product".
   - "discard": If it is a meme, personal chat, irrelevant news, or does not fit "AI/Design/Product".

2. If TYPE is "content":
   - Extract a summary as 'title'.
   - Extract details as 'description'.
   - Classify 'category' strictly into one of: ["AI", "Design", "Product"].

3. If TYPE is "todo":
   - Extract the task name as 'title'.
   - Extract details as 'description'.
   - Extract 'assigneeName' (just the name text) if present.
   - Calculate 'dueDate' based on Current System Time if mentioned (e.g., "next Friday"). Return YYYY-MM-DD.

4. Output ONLY valid JSON matching the schema provided.
5. 业务逻辑流 (Business Logic / Fit)
5.1 初始化流 (Setup)
检查本地 AppState。
若 ID 缺失 -> 调用 Notion API (search 或 create)。
Step 1: Create Page "S" ([App] Inbox).
Step 2: Create Inline Database "Visual Knowledge" inside Page S.
Step 3: Create Inline Database "Visual Tasks" inside Page S.
保存 ID 到本地。
5.2 处理流 (The Pipeline)
Capture: 获取截图 + URL (Metadata)。
Atomize:
将图片 (Base64) + URL + 当前时间 发送给云端 VLM。
获取 JSON Response。
Filter (分诊):
if atom.type == .discard: 停止处理，记录日志（可选反馈）。
else: 进入下一步。
Fit (适配):
Content Logic:
构建 Notion Page Properties。
Mapping: atom.payload.category -> Notion Select Option.
注意: 即使 VLM 返回了图片，因为方案 B，我们不构建 Image Block，仅构建 Text Blocks。
Todo Logic:
构建 Notion Page Properties。
Mapping: atom.payload.assigneeName -> Notion Rich Text (Content).
Mapping: atom.payload.dueDate -> Notion Date Property.
Execute:
调用 Notion API (POST https://api.notion.com/v1/pages).
静默处理: 不阻塞 UI，成功后不弹窗（或仅在状态栏闪烁），失败记录错误日志。
6. 开发注意事项 (Dev Notes for Cursor)
Notion API: 使用 2022-06-28 或更新版本。
Image Handling: 不要在 API 请求中发送 files 属性，除非你准备好了外部图床链接。V1.1 忽略图片上传。
Error Handling: 如果 Category 不在 Notion 的 Select Options 里，API 会报错。代码中需确保：在创建 Database 时预先定义好 Options，或者在 Insert 时使用 select: { "name": "AI" } 让 Notion 自动创建（如果权限允许）。建议预定义。
Date Parsing: VLM 返回的日期字符串必须是标准的 YYYY-MM-DD，否则 Notion API 会报错 (400 Bad Request)。Fit 层要做一次正则校验。
指令：
请将以上规格书发给 Cursor AI，并要求它：
先创建 NotionManager.swift 负责 API 通信。
再创建 Atom.swift 定义数据模型。
最后编写 PipelineController.swift 串联逻辑。